                 -1   $MODDE2
0000              1   ;  MODDDE2: Register definition for DE2-8052 softcore
0000              2   ;
0000              3   ;   Copyright (C) 2011  Jesus Calvino-Fraga, jesusc at ece.ubc.ca
0000              4   ;
0000              5   ;   This library is free software; you can redistribute it and/or
0000              6   ;   modify it under the terms of the GNU Lesser General Public
0000              7   ;   License as published by the Free Software Foundation; either
0000              8   ;   version 2.1 of the License, or (at your option) any later version.
0000              9   ;
0000             10   ;   This library is distributed in the hope that it will be useful,
0000             11   ;   but WITHOUT ANY WARRANTY; without even the implied warranty of
0000             12   ;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
0000             13   ;   Lesser General Public License for more details.
0000             14   ;
0000             15   ;   You should have received a copy of the GNU Lesser General Public
0000             16   ;   License along with this library; if not, write to the Free Software
0000             17   ;   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
0000             18   ;
0000             19       
0000             20   P0     DATA  080H  ;PORT 0
0000             21   SP     DATA  081H  ;STACK POINTER
0000             22   DPL    DATA  082H  ;DATA POINTER - LOW BYTE
0000             23   DPH    DATA  083H  ;DATA POINTER - HIGH BYTE
0000             24   PCON   DATA  087H  ;POWER CONTROL
0000             25   TCON   DATA  088H  ;TIMER CONTROL
0000             26   TMOD   DATA  089H  ;TIMER MODE
0000             27   TL0    DATA  08AH  ;TIMER 0 - LOW BYTE
0000             28   TL1    DATA  08BH  ;TIMER 1 - LOW BYTE
0000             29   TH0    DATA  08CH  ;TIMER 0 - HIGH BYTE
0000             30   TH1    DATA  08DH  ;TIMER 1 - HIGH BYTE
0000             31   P1     DATA  090H  ;PORT 1
0000             32   SCON   DATA  098H  ;SERIAL PORT CONTROL
0000             33   SBUF   DATA  099H  ;SERIAL PORT BUFFER
0000             34   P2     DATA  0A0H  ;PORT 2
0000             35   IE     DATA  0A8H  ;INTERRUPT ENABLE
0000             36   P3     DATA  0B0H  ;PORT 3
0000             37   IP     DATA  0B8H  ;INTERRUPT PRIORITY
0000             38   T2CON  DATA  0C8H  ;TIMER 2 CONTROL
0000             39   T2MOD  DATA  0C9H  ;TIMER 2 MODE
0000             40   RCAP2L DATA  0CAH  ;TIMER 2 CAPTURE REGISTER - LOW BYTE
0000             41   RCAP2H DATA  0CBH  ;TIMER 2 CAPTURE REGISTER - HIGH BYTE
0000             42   TL2    DATA  0CCH  ;TIMER 2 - LOW BYTE
0000             43   TH2    DATA  0CDH  ;TIMER 2 - HIGH BYTE
0000             44   PSW    DATA  0D0H  ;PROGRAM STATUS WORD
0000             45   ACC    DATA  0E0H  ;ACCUMULATOR
0000             46   B      DATA  0F0H  ;MULTIPLICATION REGISTER
0000             47   IT0    BIT   088H  ;TCON.0 - EXT. INTERRUPT 0 TYPE
0000             48   IE0    BIT   089H  ;TCON.1 - EXT. INTERRUPT 0 EDGE FLAG
0000             49   IT1    BIT   08AH  ;TCON.2 - EXT. INTERRUPT 1 TYPE
0000             50   IE1    BIT   08BH  ;TCON.3 - EXT. INTERRUPT 1 EDGE FLAG
0000             51   TR0    BIT   08CH  ;TCON.4 - TIMER 0 ON/OFF CONTROL
0000             52   TF0    BIT   08DH  ;TCON.5 - TIMER 0 OVERFLOW FLAG
0000             53   TR1    BIT   08EH  ;TCON.6 - TIMER 1 ON/OFF CONTROL
0000             54   TF1    BIT   08FH  ;TCON.7 - TIMER 1 OVERFLOW FLAG
0000             55   RI     BIT   098H  ;SCON.0 - RECEIVE INTERRUPT FLAG
0000             56   TI     BIT   099H  ;SCON.1 - TRANSMIT INTERRUPT FLAG
0000             57   RB8    BIT   09AH  ;SCON.2 - RECEIVE BIT 8
0000             58   TB8    BIT   09BH  ;SCON.3 - TRANSMIT BIT 8
0000             59   REN    BIT   09CH  ;SCON.4 - RECEIVE ENABLE
0000             60   SM2    BIT   09DH  ;SCON.5 - SERIAL MODE CONTROL BIT 2
0000             61   SM1    BIT   09EH  ;SCON.6 - SERIAL MODE CONTROL BIT 1
0000             62   SM0    BIT   09FH  ;SCON.7 - SERIAL MODE CONTROL BIT 0
0000             63   EX0    BIT   0A8H  ;IE.0 - EXTERNAL INTERRUPT 0 ENABLE
0000             64   ET0    BIT   0A9H  ;IE.1 - TIMER 0 INTERRUPT ENABLE
0000             65   EX1    BIT   0AAH  ;IE.2 - EXTERNAL INTERRUPT 1 ENABLE
0000             66   ET1    BIT   0ABH  ;IE.3 - TIMER 1 INTERRUPT ENABLE
0000             67   ES     BIT   0ACH  ;IE.4 - SERIAL PORT INTERRUPT ENABLE
0000             68   ET2    BIT   0ADH  ;IE.5 - TIMER 2 INTERRUPT ENABLE
0000             69   EA     BIT   0AFH  ;IE.7 - GLOBAL INTERRUPT ENABLE
0000             70   RXD    BIT   0B0H  ;P3.0 - SERIAL PORT RECEIVE INPUT
0000             71   TXD    BIT   0B1H  ;P3.1 - SERIAL PORT TRANSMIT OUTPUT
0000             72   INT0   BIT   0B2H  ;P3.2 - EXTERNAL INTERRUPT 0 INPUT
0000             73   INT1   BIT   0B3H  ;P3.3 - EXTERNAL INTERRUPT 1 INPUT
0000             74   T0     BIT   0B4H  ;P3.4 - TIMER 0 COUNT INPUT
0000             75   T1     BIT   0B5H  ;P3.5 - TIMER 1 COUNT INPUT
0000             76   WR     BIT   0B6H  ;P3.6 - WRITE CONTROL FOR EXT. MEMORY
0000             77   RD     BIT   0B7H  ;P3.7 - READ CONTROL FOR EXT. MEMORY
0000             78   PX0    BIT   0B8H  ;IP.0 - EXTERNAL INTERRUPT 0 PRIORITY
0000             79   PT0    BIT   0B9H  ;IP.1 - TIMER 0 PRIORITY
0000             80   PX1    BIT   0BAH  ;IP.2 - EXTERNAL INTERRUPT 1 PRIORITY
0000             81   PT1    BIT   0BBH  ;IP.3 - TIMER 1 PRIORITY
0000             82   PS     BIT   0BCH  ;IP.4 - SERIAL PORT PRIORITY
0000             83   PT2    BIT   0BDH  ;IP.5 - TIMER 2 PRIORITY
0000             84   CAP2   BIT   0C8H  ;T2CON.0 - CAPTURE OR RELOAD SELECT
0000             85   CNT2   BIT   0C9H  ;T2CON.1 - TIMER OR COUNTER SELECT
0000             86   TR2    BIT   0CAH  ;T2CON.2 - TIMER 2 ON/OFF CONTROL
0000             87   EXEN2  BIT   0CBH  ;T2CON.3 - TIMER 2 EXTERNAL ENABLE FLAG
0000             88   TCLK   BIT   0CCH  ;T2CON.4 - TRANSMIT CLOCK SELECT
0000             89   RCLK   BIT   0CDH  ;T2CON.5 - RECEIVE CLOCK SELECTT
0000             90   EXF2   BIT   0CEH  ;T2CON.6 - EXTERNAL TRANSITION FLAG
0000             91   TF2    BIT   0CFH  ;T2CON.7 - TIMER 2 OVERFLOW FLAG
0000             92   P      BIT   0D0H  ;PSW.0 - ACCUMULATOR PARITY FLAG
0000             93   OV     BIT   0D2H  ;PSW.2 - OVERFLOW FLAG
0000             94   RS0    BIT   0D3H  ;PSW.3 - REGISTER BANK SELECT 0
0000             95   RS1    BIT   0D4H  ;PSW.4 - REGISTER BANK SELECT 1
0000             96   F0     BIT   0D5H  ;PSW.5 - FLAG 0
0000             97   AC     BIT   0D6H  ;PSW.6 - AUXILIARY CARRY FLAG
0000             98   CY     BIT   0D7H  ;PSW.7 - CARRY FLAG
0000             99   
0000            100   ; For the altera DE2 configured with an 8051/8052 softcore processor
0000            101   ; we have the following extra registers:
0000            102   
0000            103   HEX0   DATA  091H ; Zero turns the segment on
0000            104   HEX1   DATA  092H ; 
0000            105   HEX2   DATA  093H ; 
0000            106   HEX3   DATA  094H ; 
0000            107   HEX4   DATA  08EH ;
0000            108   HEX5   DATA  08FH ;
0000            109   HEX6   DATA  096H ;
0000            110   HEX7   DATA  097H ;
0000            111   
0000            112   P0MOD  DATA  09AH ; Input/output mode bits for port 0.  '1' sets the port to output mode.
0000            113   P1MOD  DATA  09BH ; Input/output mode bits for port 1
0000            114   P2MOD  DATA  09CH ; Input/output mode bits for port 2
0000            115   P3MOD  DATA  09DH ; Input/output mode bits for port 3
0000            116   
0000            117   LEDRA  DATA  0E8H ; LEDs LEDR0 to LEDR7 (bit addressable, ex: LEDRA.1 for LEDR1)
0000            118   LEDRB  DATA  095H ; LEDs LEDR8 to LEDR15
0000            119   LEDRC  DATA  09EH ; LEDs LEDR16, LEDR15, and LEDG8
0000            120   LEDG   DATA  0F8H ; LEDs LEDG0 to LEDG7 (bit addressable, ex: LEDG.3 for LEDG3)
0000            121   SWA    DATA  0E8H ; Switches SW0 to SW7 (bit addressable, ex: SWA.1 for SW1)
0000            122   SWB    DATA  095H ; Switches SW8 to SW15
0000            123   SWC    DATA  09EH ; Switches SW16 and SW17
0000            124   KEY    DATA  0F8H ; KEY1=KEY.1, KEY2=KEY.2, KEY3=KEY.3.  KEY0 is the reset button! 
0000            125   
0000            126   LCD_CMD   DATA 0D8H ;
0000            127   LCD_DATA  DATA 0D9H ;
0000            128   LCD_MOD   DATA 0DAH ; Write 0xff to make LCD_DATA an output
0000            129   LCD_RW    BIT  0D8H ; '0' writes to LCD
0000            130   LCD_EN    BIT  0D9H ; Toggle from '1' to '0'
0000            131   LCD_RS    BIT  0DAH ; '0' for commands, '1' for data
0000            132   LCD_ON    BIT  0DBH ; Write '1' to power the LCD
0000            133   LCD_BLON  BIT  0DCH ; Write '1' to turn on back light
0000            134   
0000            135   FLASH_CMD  data 0DBH ; The control bits of the flash memory:
0000            136   ; bit 0: FL_RST_N  Set to 1 for normal operation
0000            137   ; bit 1: FL_WE_N
0000            138   ; bit 2: FL_OE_N
0000            139   ; bit 3: FL_CE_N
0000            140   FLASH_DATA data 0DCH ; 8-bit data bus of flash memory.
0000            141   FLASH_MOD  data 0DDH ; 0xff makes FLASH_DATA output.  0x00 makes FLASH_DATA input.
0000            142   FLASH_ADD0 data 0E1H ; address bits 0 to 7.
0000            143   FLASH_ADD1 data 0E2H ; address bits 8 to 15.
0000            144   FLASH_ADD2 data 0E3H ; address bits 16 to 21.
0000            145   
0000              2   org 0000H
0000 75817F       3            mov SP, #7FH
0003 020354       4            ljmp PowerOff
000B              5   org 000BH
000B 0200C5       6            ljmp Interupt0
001B              7   org 001BH
001B 0200BC       8            ljmp Interupt1
001E              9   
001E             10   CoolConst   EQU 60
001E             11   ReflowConst EQU 220
001E             12   SoakConst   EQU 150
001E             13   CSEG
001E             14   
                 -1   $include(DisplayandMacros.asm)	
001E              1   ;
001E              2   ;Functions for displaying the time using seconds
001E              3   ;                   for displaying the oven temp
001E              4   ;little useful functions like wait
001E              5   ; Beep to make short buzzer pulse                        
001E              6   
001E              7   
                  8   Display_Any MAC
                  9   	mov x, %0
                 10   	mov x+1, #0
                 11   	lcall hex2bcd
                 12   	mov dptr, #myLUT
                 13   	; Display Digit 0
                 14       mov A, bcd+0
                 15       anl a, #0fh
                 16       movc A, @A+dptr
                 17       mov HEX4, A
                 18   	; Display Digit 1
                 19       mov A, bcd+0
                 20       swap a
                 21       anl a, #0fh
                 22       movc A, @A+dptr
                 23       mov HEX5, A    
                 24       ; Display Digit 2
                 25       mov A, bcd+1
                 26       anl a, #0fh
                 27       jz Ender_%0
                 28       movc A, @A+dptr
                 29       mov HEX6, A
                 30       jmp Exit_%0
                 31       Ender_%0:
                 32       mov HEX6, #0FFH
                 33       Exit_%0:
                 34   endmac
001E             35   
001E             36   clear_hex:
001E C0E0        37            push ACC
0020 74FF        38            mov A, #0FFH
0022 F58E        39            mov HEX4, A
0024 F58F        40            mov HEX5, A
0026 F596        41            mov HEX6, A
0028 D0E0        42            pop ACC
002A 22          43            ret
002B             44   display_Time:
002B 853235      45            mov x, seconds
002E 753600      46            mov x+1, #0
0031 12017A      47            lcall hex2bcd
0034 900086      48            mov dptr, #myLUT
0037             49            ; Display Digit 0
0037 E53D        50       mov A, bcd+0
0039 540F        51       anl a, #0fh
003B 93          52       movc A, @A+dptr
003C F58E        53       mov HEX4, A
003E             54            ; Display Digit 1
003E E53D        55       mov A, bcd+0
0040 C4          56       swap a
0041 540F        57       anl a, #0fh
0043 93          58       movc A, @A+dptr
0044 F58F        59       mov HEX5, A    
0046             60       ; Display Digit 2
0046 E53E        61       mov A, bcd+1
0048 540F        62       anl a, #0fh
004A 93          63       movc A, @A+dptr
004B F596        64       mov HEX6, A
004D 22          65       ret   
004E             66   display_Temp:
004E 854635      67            mov x, Oven_Temp
0051 753600      68            mov x+1, #0
0054 12017A      69            lcall hex2bcd
0057 900086      70            mov dptr, #myLUT
005A             71            ; Display Digit 0
005A E53D        72       mov A, bcd+0
005C 540F        73       anl a, #0fh
005E 93          74       movc A, @A+dptr
005F F591        75       mov HEX0, A
0061             76            ; Display Digit 1
0061 E53D        77       mov A, bcd+0
0063 C4          78       swap a
0064 540F        79       anl a, #0fh
0066 93          80       movc A, @A+dptr
0067 F592        81       mov HEX1, A
0069             82       ; Display Digit 2
0069 E53E        83       mov A, bcd+1
006B 540F        84       anl a, #0fh
006D 93          85       movc A, @A+dptr
006E F593        86       mov HEX2, A  
0070 22          87       ret   
0071             88   Wait:
0071 7B64        89            mov R3, #100
0073 7AFA        90   L3:      mov R2, #250
0075 79FA        91   L2:      mov R1, #250
0077 D9FE        92   L1: djnz R1, L1
0079 DAFA        93            djnz R2, L2
007B DBF6        94            djnz R3, L3
007D 22          95            ret             
007E             96   Beep:
007E D2AB        97            setb ET1
0080 120071      98            lcall wait
0083 C2AB        99            clr Et1
0085 22         100            ret
0086            101   
0086            102   
0086            103   
                104   Set_Any MAC
                105   	Inc_%0:
                106   		mov A, %0
                107   	
                108   		jb KEY.2, Dec_%0
                109       	jnb KEY.2, $
                110   		inc A
                111   		cjne A, %2, Done_%0
                112   		dec A
                113   	Dec_%0:	
                114      	    jb KEY.3, Done_%0
                115      	    jnb KEY.3, $
                116   		dec A
                117   	    cjne A, %1, Done_%0
                118           inc A
                119   	Done_%0:
                120   		mov %0, A
                121   endmac
0086            122   
0086            123   END      
                 -1   $include(HeatingandTimer.asm)
0086              1   
0086              2   XTAL           EQU 33333333                     ;Clock Frequency
0086              3   FREQ           EQU 100                          
0086              4   HERTZ          EQU 2000                         ;Buzzer Frequency
0086              5   BAUD                EQU 115200                       ;Baud Rate
0086              6   T2LOAD              EQU 65536-(XTAL/(32*BAUD))
0086              7   TIMER0_RELOAD  EQU 65538-(XTAL/(12*FREQ))
0086              8   BUZZER_RELOAD  EQU 65538-(XTAL/(12*HERTZ))       
0086              9   TURNONOVEN     EQU P0.0                         ;Controls oven
0086             10   BUZZER         EQU P0.3                          ; buzzer pin
0086             11   SERIALRATE     EQU 10                            ; Readings sent to comp per second
0086             12   
0086             13   myLUT:
0086 C0F9A4B0    14       DB 0C0H, 0F9H, 0A4H, 0B0H, 099H        ; 0 TO 4
     99
008B 9282F880    15       DB 092H, 082H, 0F8H, 080H, 090H        ; 4 TO 9
     90
0090             16   ;------------------------------
0090             17   ; Set up timers, 
0090             18   ; Does not start them or enable INT
0090             19   ;------------------------------
0090             20   Initialize_Timer:
0090 758911      21            mov TMOD,  #00010001B ; 16-bit timers
0093 C28C        22            clr TR0
0095 C28E        23            clr TR1
0097 C28D        24            clr TF0
0099 C28F        25            clr TF1
009B C2CA        26            clr TR2 ; Disable timer 2
009D 75C830      27            mov T2CON, #30H ; RCLK=1, TCLK=1 
00A0 75CBFF      28            mov RCAP2H, #high(T2LOAD)  
00A3 75CAF7      29            mov RCAP2L, #low(T2LOAD)
00A6 D2CA        30            setb TR2 ; Enable timer 2
00A8 759852      31            mov SCON, #52H
00AB 758C93      32       mov TH0, #high(TIMER0_RELOAD)
00AE 758A81      33       mov TL0, #low(TIMER0_RELOAD)
00B1 758DFA      34       mov TH1, #high(BUZZER_RELOAD)
00B4 758B96      35       mov TL1, #low(BUZZER_RELOAD)
00B7 D28C        36       setb TR0
00B9 D28E        37       Setb TR1
00BB 22          38       ret
00BC             39   ;Buzzer Noise    
00BC             40   Interupt1:
00BC 758DFA      41            mov TH1, #high(BUZZER_RELOAD)
00BF 758B96      42       mov TL1, #low(BUZZER_RELOAD)
00C2 B283        43       cpl BUZZER
00C4 32          44            reti    
00C5             45    
00C5             46   
00C5             47         
00C5             48   ;--------------------------------
00C5             49   ;Decrements Timer Every 1 second
00C5             50   ;Checks Oven Temperature ever 1s
00C5             51   ;--------------------------------
00C5             52   Interupt0:    
00C5             53       ; Reload the timer
00C5 758C93      54       mov TH0, #high(TIMER0_RELOAD)
00C8 758A81      55       mov TL0, #low(TIMER0_RELOAD)
00CB             56       ; Save used register into the stack
00CB C0D0        57       push psw
00CD C0E0        58       push acc
00CF C083        59       push dph
00D1 C082        60       push dpl
00D3 0531        61            inc count5ms
00D5 E531        62            mov a, count5ms
00D7 B40A06      63            cjne a, #SerialRate, NoSend
00DA 753100      64            mov count5ms, #0
00DD 120122      65       lcall SendTemp       
00E0             66   NoSend:          
00E0             67            ; Increment the counter and check if a second has passed
00E0 0530        68       inc count10ms
00E2 E530        69       mov a, count10ms 
00E4 B4642A      70       cjne A, #100, Return_int
00E7 753000      71       mov count10ms, #0 
00EA C3          72       clr c
00EB             73       ;seconds has passed
00EB             74       
00EB             75       ;checks if oven is greater or equal to target (can be moved to adjust rate)
00EB E545        76       mov a, Target_Temp
00ED 9546        77       Subb a, Oven_Temp        
00EF 400A        78       jc NoHeat
00F1 6008        79       jz NoHeat
00F3             80       ;activate oven
00F3 C280        81       clr TurnOnOven
00F5             82   ;--------------------------------------------    
00F5 0546        83       inc Oven_Temp
00F7             84   ;-----------------------------------------------    
00F7 C200        85       clr Ready
00F9 8006        86       sjmp Heat
00FB             87   NoHeat:    
00FB D200        88            setb Ready  
00FD             89            ;turn off oven
00FD D280        90            setb TurnOnOven
00FF             91   ;-----------------------------------------       
00FF 1546        92       dec Oven_Temp
0101             93   ;-------------------------------------------
0101             94   Heat:
0101             95            ;if timer is active    
0101 20010D      96            jb finished, Return_int
0104 E532        97       mov a, seconds
0106 14          98       dec a
0107 F532        99       mov seconds, a
0109 B40005     100       cjne A, #00, Return_int ;FFH is -1 in two's complement
010C 753200     101       mov seconds, #00
010F D201       102       setb finished
0111            103   Return_int:
0111 D082       104            pop dpl
0113 D083       105       pop dph
0115 D0E0       106       pop acc
0117 D0D0       107       pop psw    
0119 32         108            reti
011A            109      
011A            110   end
                 -1   $include(serial.asm)
011A              1   putchar:
011A 3099FD       2       JNB TI, putchar
011D C299         3       CLR TI
011F F599         4       MOV SBUF, a
0121 22           5       RET
0122              6   SendTemp:
0122 C0E0         7            push acc
0124 AF35         8            mov R7, x
0126              9            ;Sends the oven's temperature
0126 854635      10            mov x, Oven_Temp
0129 753600      11            mov x+1, #0
012C 12017A      12            lcall Hex2Bcd
012F E53E        13            mov A, bcd+1
0131 540F        14       anl a, #0fh
0133 2430        15       add a, #48  
0135 12011A      16       lcall putchar         
0138 E53D        17            mov A, bcd+0
013A C4          18            swap a
013B 540F        19       anl a, #0fh
013D 2430        20       add a, #48
013F 12011A      21       lcall putchar
0142 E53D        22       mov A, bcd+0
0144 540F        23       anl a, #0fh
0146 2430        24       add a, #48
0148 12011A      25       lcall putchar
014B             26       ;Sends a break marker                                ;;;;;;;;;;;;;;;;;;;;;;;;;;
014B             27       ;mov a, #'\n'
014B             28       ;lcall putchar
014B             29            ;Sends the goal temperature
014B 854535      30            mov x, Target_Temp
014E 753600      31            mov x+1, #0
0151 12017A      32            lcall Hex2Bcd
0154 E53E        33            mov A, bcd+1
0156 540F        34       anl a, #0fh
0158 2430        35       add a, #48  
015A 12011A      36       lcall putchar         
015D E53D        37            mov A, bcd+0
015F C4          38            swap a
0160 540F        39       anl a, #0fh
0162 2430        40       add a, #48
0164 12011A      41       lcall putchar
0167 E53D        42       mov A, bcd+0
0169 540F        43       anl a, #0fh
016B 2430        44       add a, #48
016D 12011A      45       lcall putchar
0170 740A        46       mov a, #'\n'
0172 12011A      47       lcall putchar
0175             48       ;mov a, #'\r'
0175             49       ;lcall putchar
0175 8F35        50       mov x, R7
0177 D0E0        51       pop acc
0179 22          52            ret     
017A             53            
017A             54   END      
                 -1   $include(math16.asm)
                428   $LIST
0354             19                    
0030             20   DSEG at 30H
0030             21            ;Overflow Counter
0030             22            count10ms: ds 1
0031             23            count5ms: ds 1
0032             24            ;Universal for time
0032             25            seconds:   ds 1
0033             26            minutes:   ds 1
0034             27            hours:     ds 1
0035             28            ;math variables
0035             29            x:                 ds 4
0039             30            y:         ds 4
003D             31            bcd:       ds 4
0041             32            ;Oven Settables
0041             33            Reflow_Temp: Ds 1
0042             34            Reflow_Time: Ds 1
0043             35            Soak_Temp:   Ds 1
0044             36            Soak_Time:       Ds 1
0045             37            ;Universal for temp
0045             38            Target_Temp: Ds 1
0046             39            ;Enviroment
0046             40            Oven_Temp:   Ds 1
0000             41   BSEG
0000             42            ;booleans
0000             43            Ready:       Dbit 1
0001             44            Finished:    dbit 1
0002             45            Timing:      dbit 1
0003             46            mf:          dbit 1
0354             47   CSEG
0354             48   
0354             49   ;Stops Everything until switch 1 is turned back on (Not Done)
0354             50   PowerOff:
0354 759AFF      51            mov P0MOD, #0xFF
0357             52            ;Reset standard times
0357 7541DC      53            mov Reflow_Temp, #ReflowConst
035A 75421E      54            mov Reflow_Time, #30
035D 754396      55            mov Soak_Temp,   #SoakConst
0360 75444B      56            mov Soak_Time,   #75
0363 E59E        57            mov a, SWC
0365 D2AF        58            setb EA         
0367 30E1EA      59            jnb acc.1, PowerOff
036A 02036D      60            ljmp PowerOn
036D             61   ;Initial Set up  on reboot
036D             62   PowerOn:
036D 120090      63            lcall Initialize_Timer
0370 75468C      64            mov Oven_Temp, #140
0373             65            ;Turn off LED's
0373 75E800      66            mov LEDRA, #0
0376 759500      67            mov LEDRB, #0
0379 759E00      68            mov LEDRC, #0
037C 75F800      69            mov LEDG, #0
037F D2CA        70            setb TR2
0381 020384      71            ljmp Idle       
0384             72            
0384             73   ;awaiting process loop   
0384             74   Idle:
0384 754500      75            mov Target_Temp, #0
0387 C202        76            clr timing
0389 D2A9        77            setb ET0
038B D2F9        78            setb LEDG.1
038D             79            ;Stop Timer
038D             80            ;set things while switch is up, return by flicking down
038D 20E935      81            jb SWA.1, Set_Reflow_Time
0390 20EA27      82            jb SWA.2, Set_Reflow_Temp
0393 20EB19      83            jb SWA.3, Set_Soak_Time
0396 20EC0B      84            jb SWA.4, Set_Soak_Temp
0399 20F9E8      85            jb Key.1, Idle
039C             86            ;ready to start process
039C 12007E      87            lcall beep
039F C200        88            clr Ready
03A1 0203D0      89            ljmp Preheat_Soak
03A4             90            
03A4             91   ;------------------------------------------------------------------      
03A4             92   ;Setting Times and Temperatures (Not Done)
03A4             93   ;   -had thought maybe macro for time and temp, that takes bounds 
03A4             94   ;   so the time or temp is within reason
03A4             95   ;------------------------------------------------------------------
03A4             96   Set_Soak_Temp:
03A4 1204BF      97            lcall Set_Soak_Temp_Relay
03A7 20ECFA      98            jb SWA.4, Set_Soak_Temp
03AA 12001E      99            lcall clear_hex
03AD 80D5       100            sjmp Idle
03AF            101   Set_Soak_Time:
03AF 120504     102            lcall Set_Soak_Time_Relay
03B2 20EBFA     103            jb SWA.3, Set_Soak_Time
03B5 12001E     104            lcall clear_hex
03B8 80CA       105            Sjmp Idle
03BA            106   Set_Reflow_Temp:
03BA 12047A     107            lcall Set_Reflow_Temp_Relay
03BD 20EAFA     108            jb SWA.2, Set_Reflow_Temp
03C0 12001E     109            lcall clear_hex
03C3 80BF       110            Sjmp Idle
03C5            111   Set_Reflow_Time:
03C5 120435     112            lcall Set_Reflow_Time_Relay     
03C8 20E9FA     113            jb SWA.1, Set_Reflow_Time
03CB 12001E     114            lcall clear_hex
03CE 80B4       115            Sjmp Idle
03D0            116   
03D0            117   ;------------------------------------------------------------------      
03D0            118   ;Actual Progression Through Phases
03D0            119   ;PRE-HEAT
03D0            120   ;SOAK
03D0            121   ;PRE-HEAT
03D0            122   ;REFLOW
03D0            123   ;COOLING
03D0            124   ;DONE
03D0            125   ;------------------------------------------------------------------
03D0            126   
03D0            127   ;Waits for temperature to get above soak temp
03D0            128   Preheat_Soak:
03D0 D2FA       129            setb LEDG.2
03D2 854345     130            mov Target_Temp, Soak_Temp
03D5 3000F8     131            jnb Ready, PreHeat_Soak
03D8 12007E     132            lcall beep
03DB            133   ;Initialize for holding constant
03DB D2FB       134            setb LEDG.3
03DD 854432     135            mov seconds, Soak_Time+0
03E0 C201       136            clr finished     
03E2            137   WaitSoak:
03E2 12002B     138            lcall display_time      
03E5 3001FA     139            jnb finished, WaitSoak
03E8            140   ;Initilize for ramp to Reflow
03E8 12001E     141            lcall clear_hex
03EB D2FC       142            setb LEDG.4
03ED 12007E     143            lcall beep
03F0 854145     144            mov Target_Temp, Reflow_Temp
03F3 C200       145            clr ready
03F5            146   Preheat_Reflow:
03F5 3000FD     147            jnb Ready, PreHeat_Reflow
03F8 12007E     148            lcall beep
03FB            149   ;Pass Reflow Time, wait for time to expire       
03FB D2FD       150            setb LEDG.5
03FD 854232     151            mov seconds, Reflow_Time+0
0400 C201       152            clr finished
0402            153   WaitReflow:
0402 12002B     154            lcall display_time      
0405 3001FA     155            jnb finished, WaitReflow
0408 12001E     156            lcall clear_hex
040B 12007E     157            lcall beep
040E            158   ;Process Finished, Wait for it to cool
040E            159   Cooling:
040E 75453C     160            mov Target_Temp, #CoolConst
0411 D200       161            setb ready      
0413            162   WaitCool:        
0413 D2FE       163            setb LEDG.6
0415            164            ;wait for temp to dip below 60 Celcius (Cool Constant)
0415 2000FB     165            jb Ready, WaitCool
0418            166            ;set temp to zero
0418 754500     167            mov Target_Temp, #0
041B            168            ;triple beep
041B 12007E     169            lcall beep
041E 120071     170            lcall wait
0421 12007E     171            lcall beep
0424 120071     172            lcall wait
0427 12007E     173            lcall beep
042A            174   ;Cool Enough (just waits PB)     
042A            175   Done:
042A D2FF       176            setb LEDG.7
042C 20F9FB     177            jb Key.1, Done
042F 75F800     178            mov LEDG, #0
0432 020384     179            ljmp Idle
0435            180                    
0435            181   Set_Reflow_Time_Relay:
0435            182            Inc_Reflow_Time:
0435 E542       182                    mov A, Reflow_Time
0437            182            
0437 20FA08     182                    jb KEY.2, Dec_Reflow_Time
043A 30FAFD     182            jnb KEY.2, $
043D 04         182                    inc A
043E B42E0C     182                    cjne A, #46, Done_Reflow_Time
0441 14         182                    dec A
0442            182            Dec_Reflow_Time:        
0442 20FB08     182                jb KEY.3, Done_Reflow_Time
0445 30FBFD     182                jnb KEY.3, $
0448 14         182                    dec A
0449 B41D01     182                cjne A, #29, Done_Reflow_Time
044C 04         182           inc A
044D            182            Done_Reflow_Time:
044D F542       182                    mov Reflow_Time, A
044F 854235     183            mov x, Reflow_Time
0452 753600     183            mov x+1, #0
0455 12017A     183            lcall hex2bcd
0458 900086     183            mov dptr, #myLUT
045B            183            ; Display Digit 0
045B E53D       183       mov A, bcd+0
045D 540F       183       anl a, #0fh
045F 93         183       movc A, @A+dptr
0460 F58E       183       mov HEX4, A
0462            183            ; Display Digit 1
0462 E53D       183       mov A, bcd+0
0464 C4         183       swap a
0465 540F       183       anl a, #0fh
0467 93         183       movc A, @A+dptr
0468 F58F       183       mov HEX5, A    
046A            183       ; Display Digit 2
046A E53E       183       mov A, bcd+1
046C 540F       183       anl a, #0fh
046E 6006       183       jz Ender_Reflow_Time
0470 93         183       movc A, @A+dptr
0471 F596       183       mov HEX6, A
0473 020479     183       jmp Exit_Reflow_Time
0476            183       Ender_Reflow_Time:
0476 7596FF     183       mov HEX6, #0FFH
0479            183       Exit_Reflow_Time:
0479 22         184            ret     
047A            185   Set_Reflow_Temp_Relay:
047A            186            Inc_Reflow_Temp:
047A E541       186                    mov A, Reflow_Temp
047C            186            
047C 20FA08     186                    jb KEY.2, Dec_Reflow_Temp
047F 30FAFD     186            jnb KEY.2, $
0482 04         186                    inc A
0483 B4E70C     186                    cjne A, #231, Done_Reflow_Temp
0486 14         186                    dec A
0487            186            Dec_Reflow_Temp:        
0487 20FB08     186                jb KEY.3, Done_Reflow_Temp
048A 30FBFD     186                jnb KEY.3, $
048D 14         186                    dec A
048E B4C701     186                cjne A, #199, Done_Reflow_Temp
0491 04         186           inc A
0492            186            Done_Reflow_Temp:
0492 F541       186                    mov Reflow_Temp, A
0494 854135     187            mov x, Reflow_Temp
0497 753600     187            mov x+1, #0
049A 12017A     187            lcall hex2bcd
049D 900086     187            mov dptr, #myLUT
04A0            187            ; Display Digit 0
04A0 E53D       187       mov A, bcd+0
04A2 540F       187       anl a, #0fh
04A4 93         187       movc A, @A+dptr
04A5 F58E       187       mov HEX4, A
04A7            187            ; Display Digit 1
04A7 E53D       187       mov A, bcd+0
04A9 C4         187       swap a
04AA 540F       187       anl a, #0fh
04AC 93         187       movc A, @A+dptr
04AD F58F       187       mov HEX5, A    
04AF            187       ; Display Digit 2
04AF E53E       187       mov A, bcd+1
04B1 540F       187       anl a, #0fh
04B3 6006       187       jz Ender_Reflow_Temp
04B5 93         187       movc A, @A+dptr
04B6 F596       187       mov HEX6, A
04B8 0204BE     187       jmp Exit_Reflow_Temp
04BB            187       Ender_Reflow_Temp:
04BB 7596FF     187       mov HEX6, #0FFH
04BE            187       Exit_Reflow_Temp:
04BE 22         188            ret     
04BF            189   Set_Soak_Temp_Relay:     
04BF            190            Inc_Soak_Temp:
04BF E543       190                    mov A, Soak_Temp
04C1            190            
04C1 20FA08     190                    jb KEY.2, Dec_Soak_Temp
04C4 30FAFD     190            jnb KEY.2, $
04C7 04         190                    inc A
04C8 B4A50C     190                    cjne A, #165, Done_Soak_Temp
04CB 14         190                    dec A
04CC            190            Dec_Soak_Temp:  
04CC 20FB08     190                jb KEY.3, Done_Soak_Temp
04CF 30FBFD     190                jnb KEY.3, $
04D2 14         190                    dec A
04D3 B48601     190                cjne A, #134, Done_Soak_Temp
04D6 04         190           inc A
04D7            190            Done_Soak_Temp:
04D7 F543       190                    mov Soak_Temp, A
04D9 854335     191            mov x, Soak_Temp
04DC 753600     191            mov x+1, #0
04DF 12017A     191            lcall hex2bcd
04E2 900086     191            mov dptr, #myLUT
04E5            191            ; Display Digit 0
04E5 E53D       191       mov A, bcd+0
04E7 540F       191       anl a, #0fh
04E9 93         191       movc A, @A+dptr
04EA F58E       191       mov HEX4, A
04EC            191            ; Display Digit 1
04EC E53D       191       mov A, bcd+0
04EE C4         191       swap a
04EF 540F       191       anl a, #0fh
04F1 93         191       movc A, @A+dptr
04F2 F58F       191       mov HEX5, A    
04F4            191       ; Display Digit 2
04F4 E53E       191       mov A, bcd+1
04F6 540F       191       anl a, #0fh
04F8 6006       191       jz Ender_Soak_Temp
04FA 93         191       movc A, @A+dptr
04FB F596       191       mov HEX6, A
04FD 020503     191       jmp Exit_Soak_Temp
0500            191       Ender_Soak_Temp:
0500 7596FF     191       mov HEX6, #0FFH
0503            191       Exit_Soak_Temp:
0503 22         192            ret     
0504            193   Set_Soak_Time_Relay:
0504            194            Inc_Soak_Time:
0504 E544       194                    mov A, Soak_Time
0506            194            
0506 20FA08     194                    jb KEY.2, Dec_Soak_Time
0509 30FAFD     194            jnb KEY.2, $
050C 04         194                    inc A
050D B45B0C     194                    cjne A, #91, Done_Soak_Time
0510 14         194                    dec A
0511            194            Dec_Soak_Time:  
0511 20FB08     194                jb KEY.3, Done_Soak_Time
0514 30FBFD     194                jnb KEY.3, $
0517 14         194                    dec A
0518 B43B01     194                cjne A, #59, Done_Soak_Time
051B 04         194           inc A
051C            194            Done_Soak_Time:
051C F544       194                    mov Soak_Time, A
051E 854435     195            mov x, Soak_Time
0521 753600     195            mov x+1, #0
0524 12017A     195            lcall hex2bcd
0527 900086     195            mov dptr, #myLUT
052A            195            ; Display Digit 0
052A E53D       195       mov A, bcd+0
052C 540F       195       anl a, #0fh
052E 93         195       movc A, @A+dptr
052F F58E       195       mov HEX4, A
0531            195            ; Display Digit 1
0531 E53D       195       mov A, bcd+0
0533 C4         195       swap a
0534 540F       195       anl a, #0fh
0536 93         195       movc A, @A+dptr
0537 F58F       195       mov HEX5, A    
0539            195       ; Display Digit 2
0539 E53E       195       mov A, bcd+1
053B 540F       195       anl a, #0fh
053D 6006       195       jz Ender_Soak_Time
053F 93         195       movc A, @A+dptr
0540 F596       195       mov HEX6, A
0542 020548     195       jmp Exit_Soak_Time
0545            195       Ender_Soak_Time:
0545 7596FF     195       mov HEX6, #0FFH
0548            195       Exit_Soak_Time:
0548 22         196            ret
0549            197                    
0549            198   END
