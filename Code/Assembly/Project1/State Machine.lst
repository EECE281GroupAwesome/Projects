                 -1   $MODDE2
0000              1   ;  MODDDE2: Register definition for DE2-8052 softcore
0000              2   ;
0000              3   ;   Copyright (C) 2011  Jesus Calvino-Fraga, jesusc at ece.ubc.ca
0000              4   ;
0000              5   ;   This library is free software; you can redistribute it and/or
0000              6   ;   modify it under the terms of the GNU Lesser General Public
0000              7   ;   License as published by the Free Software Foundation; either
0000              8   ;   version 2.1 of the License, or (at your option) any later version.
0000              9   ;
0000             10   ;   This library is distributed in the hope that it will be useful,
0000             11   ;   but WITHOUT ANY WARRANTY; without even the implied warranty of
0000             12   ;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
0000             13   ;   Lesser General Public License for more details.
0000             14   ;
0000             15   ;   You should have received a copy of the GNU Lesser General Public
0000             16   ;   License along with this library; if not, write to the Free Software
0000             17   ;   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
0000             18   ;
0000             19       
0000             20   P0     DATA  080H  ;PORT 0
0000             21   SP     DATA  081H  ;STACK POINTER
0000             22   DPL    DATA  082H  ;DATA POINTER - LOW BYTE
0000             23   DPH    DATA  083H  ;DATA POINTER - HIGH BYTE
0000             24   PCON   DATA  087H  ;POWER CONTROL
0000             25   TCON   DATA  088H  ;TIMER CONTROL
0000             26   TMOD   DATA  089H  ;TIMER MODE
0000             27   TL0    DATA  08AH  ;TIMER 0 - LOW BYTE
0000             28   TL1    DATA  08BH  ;TIMER 1 - LOW BYTE
0000             29   TH0    DATA  08CH  ;TIMER 0 - HIGH BYTE
0000             30   TH1    DATA  08DH  ;TIMER 1 - HIGH BYTE
0000             31   P1     DATA  090H  ;PORT 1
0000             32   SCON   DATA  098H  ;SERIAL PORT CONTROL
0000             33   SBUF   DATA  099H  ;SERIAL PORT BUFFER
0000             34   P2     DATA  0A0H  ;PORT 2
0000             35   IE     DATA  0A8H  ;INTERRUPT ENABLE
0000             36   P3     DATA  0B0H  ;PORT 3
0000             37   IP     DATA  0B8H  ;INTERRUPT PRIORITY
0000             38   T2CON  DATA  0C8H  ;TIMER 2 CONTROL
0000             39   T2MOD  DATA  0C9H  ;TIMER 2 MODE
0000             40   RCAP2L DATA  0CAH  ;TIMER 2 CAPTURE REGISTER - LOW BYTE
0000             41   RCAP2H DATA  0CBH  ;TIMER 2 CAPTURE REGISTER - HIGH BYTE
0000             42   TL2    DATA  0CCH  ;TIMER 2 - LOW BYTE
0000             43   TH2    DATA  0CDH  ;TIMER 2 - HIGH BYTE
0000             44   PSW    DATA  0D0H  ;PROGRAM STATUS WORD
0000             45   ACC    DATA  0E0H  ;ACCUMULATOR
0000             46   B      DATA  0F0H  ;MULTIPLICATION REGISTER
0000             47   IT0    BIT   088H  ;TCON.0 - EXT. INTERRUPT 0 TYPE
0000             48   IE0    BIT   089H  ;TCON.1 - EXT. INTERRUPT 0 EDGE FLAG
0000             49   IT1    BIT   08AH  ;TCON.2 - EXT. INTERRUPT 1 TYPE
0000             50   IE1    BIT   08BH  ;TCON.3 - EXT. INTERRUPT 1 EDGE FLAG
0000             51   TR0    BIT   08CH  ;TCON.4 - TIMER 0 ON/OFF CONTROL
0000             52   TF0    BIT   08DH  ;TCON.5 - TIMER 0 OVERFLOW FLAG
0000             53   TR1    BIT   08EH  ;TCON.6 - TIMER 1 ON/OFF CONTROL
0000             54   TF1    BIT   08FH  ;TCON.7 - TIMER 1 OVERFLOW FLAG
0000             55   RI     BIT   098H  ;SCON.0 - RECEIVE INTERRUPT FLAG
0000             56   TI     BIT   099H  ;SCON.1 - TRANSMIT INTERRUPT FLAG
0000             57   RB8    BIT   09AH  ;SCON.2 - RECEIVE BIT 8
0000             58   TB8    BIT   09BH  ;SCON.3 - TRANSMIT BIT 8
0000             59   REN    BIT   09CH  ;SCON.4 - RECEIVE ENABLE
0000             60   SM2    BIT   09DH  ;SCON.5 - SERIAL MODE CONTROL BIT 2
0000             61   SM1    BIT   09EH  ;SCON.6 - SERIAL MODE CONTROL BIT 1
0000             62   SM0    BIT   09FH  ;SCON.7 - SERIAL MODE CONTROL BIT 0
0000             63   EX0    BIT   0A8H  ;IE.0 - EXTERNAL INTERRUPT 0 ENABLE
0000             64   ET0    BIT   0A9H  ;IE.1 - TIMER 0 INTERRUPT ENABLE
0000             65   EX1    BIT   0AAH  ;IE.2 - EXTERNAL INTERRUPT 1 ENABLE
0000             66   ET1    BIT   0ABH  ;IE.3 - TIMER 1 INTERRUPT ENABLE
0000             67   ES     BIT   0ACH  ;IE.4 - SERIAL PORT INTERRUPT ENABLE
0000             68   ET2    BIT   0ADH  ;IE.5 - TIMER 2 INTERRUPT ENABLE
0000             69   EA     BIT   0AFH  ;IE.7 - GLOBAL INTERRUPT ENABLE
0000             70   RXD    BIT   0B0H  ;P3.0 - SERIAL PORT RECEIVE INPUT
0000             71   TXD    BIT   0B1H  ;P3.1 - SERIAL PORT TRANSMIT OUTPUT
0000             72   INT0   BIT   0B2H  ;P3.2 - EXTERNAL INTERRUPT 0 INPUT
0000             73   INT1   BIT   0B3H  ;P3.3 - EXTERNAL INTERRUPT 1 INPUT
0000             74   T0     BIT   0B4H  ;P3.4 - TIMER 0 COUNT INPUT
0000             75   T1     BIT   0B5H  ;P3.5 - TIMER 1 COUNT INPUT
0000             76   WR     BIT   0B6H  ;P3.6 - WRITE CONTROL FOR EXT. MEMORY
0000             77   RD     BIT   0B7H  ;P3.7 - READ CONTROL FOR EXT. MEMORY
0000             78   PX0    BIT   0B8H  ;IP.0 - EXTERNAL INTERRUPT 0 PRIORITY
0000             79   PT0    BIT   0B9H  ;IP.1 - TIMER 0 PRIORITY
0000             80   PX1    BIT   0BAH  ;IP.2 - EXTERNAL INTERRUPT 1 PRIORITY
0000             81   PT1    BIT   0BBH  ;IP.3 - TIMER 1 PRIORITY
0000             82   PS     BIT   0BCH  ;IP.4 - SERIAL PORT PRIORITY
0000             83   PT2    BIT   0BDH  ;IP.5 - TIMER 2 PRIORITY
0000             84   CAP2   BIT   0C8H  ;T2CON.0 - CAPTURE OR RELOAD SELECT
0000             85   CNT2   BIT   0C9H  ;T2CON.1 - TIMER OR COUNTER SELECT
0000             86   TR2    BIT   0CAH  ;T2CON.2 - TIMER 2 ON/OFF CONTROL
0000             87   EXEN2  BIT   0CBH  ;T2CON.3 - TIMER 2 EXTERNAL ENABLE FLAG
0000             88   TCLK   BIT   0CCH  ;T2CON.4 - TRANSMIT CLOCK SELECT
0000             89   RCLK   BIT   0CDH  ;T2CON.5 - RECEIVE CLOCK SELECTT
0000             90   EXF2   BIT   0CEH  ;T2CON.6 - EXTERNAL TRANSITION FLAG
0000             91   TF2    BIT   0CFH  ;T2CON.7 - TIMER 2 OVERFLOW FLAG
0000             92   P      BIT   0D0H  ;PSW.0 - ACCUMULATOR PARITY FLAG
0000             93   OV     BIT   0D2H  ;PSW.2 - OVERFLOW FLAG
0000             94   RS0    BIT   0D3H  ;PSW.3 - REGISTER BANK SELECT 0
0000             95   RS1    BIT   0D4H  ;PSW.4 - REGISTER BANK SELECT 1
0000             96   F0     BIT   0D5H  ;PSW.5 - FLAG 0
0000             97   AC     BIT   0D6H  ;PSW.6 - AUXILIARY CARRY FLAG
0000             98   CY     BIT   0D7H  ;PSW.7 - CARRY FLAG
0000             99   
0000            100   ; For the altera DE2 configured with an 8051/8052 softcore processor
0000            101   ; we have the following extra registers:
0000            102   
0000            103   HEX0   DATA  091H ; Zero turns the segment on
0000            104   HEX1   DATA  092H ; 
0000            105   HEX2   DATA  093H ; 
0000            106   HEX3   DATA  094H ; 
0000            107   HEX4   DATA  08EH ;
0000            108   HEX5   DATA  08FH ;
0000            109   HEX6   DATA  096H ;
0000            110   HEX7   DATA  097H ;
0000            111   
0000            112   P0MOD  DATA  09AH ; Input/output mode bits for port 0.  '1' sets the port to output mode.
0000            113   P1MOD  DATA  09BH ; Input/output mode bits for port 1
0000            114   P2MOD  DATA  09CH ; Input/output mode bits for port 2
0000            115   P3MOD  DATA  09DH ; Input/output mode bits for port 3
0000            116   
0000            117   LEDRA  DATA  0E8H ; LEDs LEDR0 to LEDR7 (bit addressable, ex: LEDRA.1 for LEDR1)
0000            118   LEDRB  DATA  095H ; LEDs LEDR8 to LEDR15
0000            119   LEDRC  DATA  09EH ; LEDs LEDR16, LEDR15, and LEDG8
0000            120   LEDG   DATA  0F8H ; LEDs LEDG0 to LEDG7 (bit addressable, ex: LEDG.3 for LEDG3)
0000            121   SWA    DATA  0E8H ; Switches SW0 to SW7 (bit addressable, ex: SWA.1 for SW1)
0000            122   SWB    DATA  095H ; Switches SW8 to SW15
0000            123   SWC    DATA  09EH ; Switches SW16 and SW17
0000            124   KEY    DATA  0F8H ; KEY1=KEY.1, KEY2=KEY.2, KEY3=KEY.3.  KEY0 is the reset button! 
0000            125   
0000            126   LCD_CMD   DATA 0D8H ;
0000            127   LCD_DATA  DATA 0D9H ;
0000            128   LCD_MOD   DATA 0DAH ; Write 0xff to make LCD_DATA an output
0000            129   LCD_RW    BIT  0D8H ; '0' writes to LCD
0000            130   LCD_EN    BIT  0D9H ; Toggle from '1' to '0'
0000            131   LCD_RS    BIT  0DAH ; '0' for commands, '1' for data
0000            132   LCD_ON    BIT  0DBH ; Write '1' to power the LCD
0000            133   LCD_BLON  BIT  0DCH ; Write '1' to turn on back light
0000            134   
0000            135   FLASH_CMD  data 0DBH ; The control bits of the flash memory:
0000            136   ; bit 0: FL_RST_N  Set to 1 for normal operation
0000            137   ; bit 1: FL_WE_N
0000            138   ; bit 2: FL_OE_N
0000            139   ; bit 3: FL_CE_N
0000            140   FLASH_DATA data 0DCH ; 8-bit data bus of flash memory.
0000            141   FLASH_MOD  data 0DDH ; 0xff makes FLASH_DATA output.  0x00 makes FLASH_DATA input.
0000            142   FLASH_ADD0 data 0E1H ; address bits 0 to 7.
0000            143   FLASH_ADD1 data 0E2H ; address bits 8 to 15.
0000            144   FLASH_ADD2 data 0E3H ; address bits 16 to 21.
0000            145   
0000              2   org 0000H
0000 75817F       3            mov SP, #7FH
0003 020402       4            ljmp PowerOff
000B              5   org 000BH
000B 020340       6            ljmp Interupt0
001B              7   org 001BH
001B 020337       8            ljmp Interupt1
001E              9   
001E             10   CoolConst   EQU 60
001E             11   ReflowConst EQU 220
001E             12   SoakConst   EQU 150
001E             13   CSEG
                 -1   $include(math16.asm)
                428   $LIST
                 -1   $include(DisplayandMacros.asm)	
01F8              1   ;
01F8              2   ;Functions for displaying the time using seconds
01F8              3   ;                   for displaying the oven temp
01F8              4   ;little useful functions like wait
01F8              5   ; Beep to make short buzzer pulse                        
01F8              6   
01F8              7   
                  8   Display_Any MAC
                  9   	mov x, %0
                 10   	mov x+1, #0
                 11   	lcall hex2bcd
                 12   	mov dptr, #myLUT
                 13   	; Display Digit 0
                 14       mov A, bcd+0
                 15       anl a, #0fh
                 16       movc A, @A+dptr
                 17       mov HEX4, A
                 18   	; Display Digit 1
                 19       mov A, bcd+0
                 20       swap a
                 21       anl a, #0fh
                 22       movc A, @A+dptr
                 23       mov HEX5, A    
                 24       ; Display Digit 2
                 25       mov A, bcd+1
                 26       anl a, #0fh
                 27       jz Ender_%0
                 28       movc A, @A+dptr
                 29       mov HEX6, A
                 30       jmp Exit_%0
                 31       Ender_%0:
                 32       mov HEX6, #0FFH
                 33       Exit_%0:
                 34   endmac
01F8             35   
01F8             36   clear_hex:
01F8 C0E0        37            push ACC
01FA 74FF        38            mov A, #0FFH
01FC F58E        39            mov HEX4, A
01FE F58F        40            mov HEX5, A
0200 F596        41            mov HEX6, A
0202 D0E0        42            pop ACC
0204 22          43            ret
0205             44   display_Time:
0205 85373A      45            mov x, seconds
0208 753B00      46            mov x+1, #0
020B 12001E      47            lcall hex2bcd
020E 900301      48            mov dptr, #myLUT
0211             49            ; Display Digit 0
0211 E542        50       mov A, bcd+0
0213 540F        51       anl a, #0fh
0215 93          52       movc A, @A+dptr
0216 F58E        53       mov HEX4, A
0218             54            ; Display Digit 1
0218 E542        55       mov A, bcd+0
021A C4          56       swap a
021B 540F        57       anl a, #0fh
021D 93          58       movc A, @A+dptr
021E F58F        59       mov HEX5, A    
0220             60       ; Display Digit 2
0220 E543        61       mov A, bcd+1
0222 540F        62       anl a, #0fh
0224 93          63       movc A, @A+dptr
0225 F596        64       mov HEX6, A
0227 22          65       ret   
0228             66   display_Temp:
0228 854B3A      67            mov x, Oven_Temp
022B 753B00      68            mov x+1, #0
022E 12001E      69            lcall hex2bcd
0231 900301      70            mov dptr, #myLUT
0234             71            ; Display Digit 0
0234 E542        72       mov A, bcd+0
0236 540F        73       anl a, #0fh
0238 93          74       movc A, @A+dptr
0239 F591        75       mov HEX0, A
023B             76            ; Display Digit 1
023B E542        77       mov A, bcd+0
023D C4          78       swap a
023E 540F        79       anl a, #0fh
0240 93          80       movc A, @A+dptr
0241 F592        81       mov HEX1, A
0243             82       ; Display Digit 2
0243 E543        83       mov A, bcd+1
0245 540F        84       anl a, #0fh
0247 93          85       movc A, @A+dptr
0248 F593        86       mov HEX2, A  
024A 22          87       ret   
024B             88   Wait:
024B 7B64        89            mov R3, #100
024D 7AFA        90   L3:      mov R2, #250
024F 79FA        91   L2:      mov R1, #250
0251 D9FE        92   L1: djnz R1, L1
0253 DAFA        93            djnz R2, L2
0255 DBF6        94            djnz R3, L3
0257 22          95            ret             
0258             96   Beep:
0258 D2AB        97            setb ET1
025A 12024B      98            lcall wait
025D C2AB        99            clr Et1
025F 22         100            ret
0260            101   
0260            102   
0260            103   
                104   Set_Any MAC
                105   	Inc_%0:
                106   		mov A, %0
                107   	
                108   		jb KEY.2, Dec_%0
                109       	jnb KEY.2, $
                110   		inc A
                111   		cjne A, %2, Done_%0
                112   		dec A
                113   	Dec_%0:	
                114      	    jb KEY.3, Done_%0
                115      	    jnb KEY.3, $
                116   		dec A
                117   	    cjne A, %1, Done_%0
                118           inc A
                119   	Done_%0:
                120   		mov %0, A
                121   endmac
0260            122   
0260            123   END      
                 -1   $include(adc_functions.asm)
                 -1   $include(HeatingandTimer.asm)
0301              1   
0301              2   XTAL           EQU 33333333                     ;Clock Frequency
0301              3   FREQ           EQU 100                          
0301              4   HERTZ          EQU 2000                         ;Buzzer Frequency
0301              5   BAUD                EQU 115200                       ;Baud Rate
0301              6   T2LOAD              EQU 65536-(XTAL/(32*BAUD))
0301              7   TIMER0_RELOAD  EQU 65538-(XTAL/(12*FREQ))
0301              8   BUZZER_RELOAD  EQU 65538-(XTAL/(12*HERTZ))       
0301              9   TURNONOVEN     EQU P0.0                         ;Controls oven
0301             10   BUZZER         EQU P0.3                          ; buzzer pin
0301             11   SERIALRATE     EQU 10                            ; Readings sent to comp per second
0301             12   
0301             13   myLUT:
0301 C0F9A4B0    14       DB 0C0H, 0F9H, 0A4H, 0B0H, 099H        ; 0 TO 4
     99
0306 9282F880    15       DB 092H, 082H, 0F8H, 080H, 090H        ; 4 TO 9
     90
030B             16   ;------------------------------
030B             17   ; Set up timers, 
030B             18   ; Does not start them or enable INT
030B             19   ;------------------------------
030B             20   Initialize_Timer:
030B 758911      21            mov TMOD,  #00010001B ; 16-bit timers
030E C28C        22            clr TR0
0310 C28E        23            clr TR1
0312 C28D        24            clr TF0
0314 C28F        25            clr TF1
0316 C2CA        26            clr TR2 ; Disable timer 2
0318 75C830      27            mov T2CON, #30H ; RCLK=1, TCLK=1 
031B 75CBFF      28            mov RCAP2H, #high(T2LOAD)  
031E 75CAF7      29            mov RCAP2L, #low(T2LOAD)
0321 D2CA        30            setb TR2 ; Enable timer 2
0323 759852      31            mov SCON, #52H
0326 758C93      32       mov TH0, #high(TIMER0_RELOAD)
0329 758A81      33       mov TL0, #low(TIMER0_RELOAD)
032C 758DFA      34       mov TH1, #high(BUZZER_RELOAD)
032F 758B96      35       mov TL1, #low(BUZZER_RELOAD)
0332 D28C        36       setb TR0
0334 D28E        37       Setb TR1
0336 22          38       ret
0337             39   ;Buzzer Noise    
0337             40   Interupt1:
0337 758DFA      41            mov TH1, #high(BUZZER_RELOAD)
033A 758B96      42       mov TL1, #low(BUZZER_RELOAD)
033D B283        43       cpl BUZZER
033F 32          44            reti    
0340             45    
0340             46   
0340             47         
0340             48   ;--------------------------------
0340             49   ;Decrements Timer Every 1 second
0340             50   ;Checks Oven Temperature ever 1s
0340             51   ;--------------------------------
0340             52   Interupt0:    
0340             53       ; Reload the timer
0340 758C93      54       mov TH0, #high(TIMER0_RELOAD)
0343 758A81      55       mov TL0, #low(TIMER0_RELOAD)
0346             56       ; Save used register into the stack
0346 C0D0        57       push psw
0348 C0E0        58       push acc
034A C083        59       push dph
034C C082        60       push dpl
034E 0536        61            inc count5ms
0350 E536        62            mov a, count5ms
0352 B40A06      63            cjne a, #SerialRate, NoSend
0355 753600      64            mov count5ms, #0
0358 1203AA      65       lcall SendTemp       
035B             66   NoSend:          
035B             67            ; Increment the counter and check if a second has passed
035B 0535        68       inc count10ms
035D E535        69       mov a, count10ms 
035F B46437      70       cjne A, #100, Return_int
0362 753500      71       mov count10ms, #0
0365 120260      72            lcall room_convert
0368 F8          72            mov R0, a
0369 88F0        72            mov b, R0
036B 120295      72            lcall oven_convert
036E 25F0        72            add a, b
0370 F54B        72            mov Oven_Temp, a 
0372 C3          73       clr c
0373             74       ;seconds has passed
0373             75       
0373             76       ;checks if oven is greater or equal to target (can be moved to adjust rate)
0373 E54A        77       mov a, Target_Temp
0375 954B        78       Subb a, Oven_Temp        
0377 400A        79       jc NoHeat
0379 6008        80       jz NoHeat
037B             81       ;activate oven
037B C280        82       clr TurnOnOven
037D             83   ;--------------------------------------------    
037D 054B        84       inc Oven_Temp
037F             85   ;-----------------------------------------------    
037F C200        86       clr Ready
0381 8006        87       sjmp Heat
0383             88   NoHeat:    
0383 D200        89            setb Ready  
0385             90            ;turn off oven
0385 D280        91            setb TurnOnOven
0387             92   ;-----------------------------------------       
0387 154B        93       dec Oven_Temp
0389             94   ;-------------------------------------------
0389             95   Heat:
0389             96            ;if timer is active    
0389 20010D      97            jb finished, Return_int
038C E537        98       mov a, seconds
038E 14          99       dec a
038F F537       100       mov seconds, a
0391 B40005     101       cjne A, #00, Return_int ;FFH is -1 in two's complement
0394 753700     102       mov seconds, #00
0397 D201       103       setb finished
0399            104   Return_int:
0399 D082       105            pop dpl
039B D083       106       pop dph
039D D0E0       107       pop acc
039F D0D0       108       pop psw    
03A1 32         109            reti
03A2            110      
03A2            111   end
                 -1   $include(serial.asm)
03A2              1   putchar:
03A2 3099FD       2       JNB TI, putchar
03A5 C299         3       CLR TI
03A7 F599         4       MOV SBUF, a
03A9 22           5       RET
03AA              6   SendTemp:
03AA C0E0         7            push acc
03AC AF3A         8            mov R7, x
03AE              9            ;Sends the oven's temperature
03AE 854B3A      10            mov x, Oven_Temp
03B1 753B00      11            mov x+1, #0
03B4 12001E      12            lcall Hex2Bcd
03B7 E543        13            mov A, bcd+1
03B9 540F        14       anl a, #0fh
03BB 2430        15       add a, #48  
03BD 1203A2      16       lcall putchar         
03C0 E542        17            mov A, bcd+0
03C2 C4          18            swap a
03C3 540F        19       anl a, #0fh
03C5 2430        20       add a, #48
03C7 1203A2      21       lcall putchar
03CA E542        22       mov A, bcd+0
03CC 540F        23       anl a, #0fh
03CE 2430        24       add a, #48
03D0 1203A2      25       lcall putchar
03D3             26       ;Sends a break marker                                ;;;;;;;;;;;;;;;;;;;;;;;;;;
03D3             27       ;mov a, #'\n'
03D3             28       ;lcall putchar
03D3             29            ;Sends the goal temperature
03D3 854A3A      30            mov x, Target_Temp
03D6 753B00      31            mov x+1, #0
03D9 12001E      32            lcall Hex2Bcd
03DC E543        33            mov A, bcd+1
03DE 540F        34       anl a, #0fh
03E0 2430        35       add a, #48  
03E2 1203A2      36       lcall putchar         
03E5 E542        37            mov A, bcd+0
03E7 C4          38            swap a
03E8 540F        39       anl a, #0fh
03EA 2430        40       add a, #48
03EC 1203A2      41       lcall putchar
03EF E542        42       mov A, bcd+0
03F1 540F        43       anl a, #0fh
03F3 2430        44       add a, #48
03F5 1203A2      45       lcall putchar
03F8 740A        46       mov a, #'\n'
03FA 1203A2      47       lcall putchar
03FD             48       ;mov a, #'\r'
03FD             49       ;lcall putchar
03FD 8F3A        50       mov x, R7
03FF D0E0        51       pop acc
0401 22          52            ret     
0402             53            
0402             54   END      
0402             19   
0402             20                    
0030             21   DSEG at 30H
0030             22            ;ADC STUFF
0030             23            ADC_out_buffer: ds 1
0031             24            ADC_in_buffer: ds 2
0033             25            last_reading: ds 2
0035             26            ;Overflow Counter
0035             27            count10ms: ds 1
0036             28            count5ms: ds 1
0037             29            ;Universal for time
0037             30            seconds:   ds 1
0038             31            minutes:   ds 1
0039             32            hours:     ds 1
003A             33            ;math variables
003A             34            x:                 ds 4
003E             35            y:         ds 4
0042             36            bcd:       ds 4
0046             37            ;Oven Settables
0046             38            Reflow_Temp: Ds 1
0047             39            Reflow_Time: Ds 1
0048             40            Soak_Temp:   Ds 1
0049             41            Soak_Time:       Ds 1
004A             42            ;Universal for temp
004A             43            Target_Temp: Ds 1
004B             44            ;Enviroment
004B             45            Oven_Temp:   Ds 1
0000             46   BSEG
0000             47            ;booleans
0000             48            Ready:       Dbit 1
0001             49            Finished:    dbit 1
0002             50            Timing:      dbit 1
0003             51            mf:          dbit 1
0402             52   CSEG
0402             53   
0402             54   ;Stops Everything until switch 1 is turned back on (Not Done)
0402             55   PowerOff:
0402 759AFF      56            mov P0MOD, #0xFF
0405             57            ;Reset standard times
0405 7546DC      58            mov Reflow_Temp, #ReflowConst
0408 75471E      59            mov Reflow_Time, #30
040B 754896      60            mov Soak_Temp,   #SoakConst
040E 75494B      61            mov Soak_Time,   #75
0411 E59E        62            mov a, SWC
0413 C2AF        63            clr EA  
0415 30E1EA      64            jnb acc.1, PowerOff
0418 02041B      65            ljmp PowerOn
041B             66   ;Initial Set up  on reboot
041B             67   PowerOn:
041B 1202C6      68            lcall ADC_Init
041E 12030B      69            lcall Initialize_Timer
0421 D2AF        70            setb EA
0423 754B8C      71            mov Oven_Temp, #140
0426             72            ;Turn off LED's
0426 75E800      73            mov LEDRA, #0
0429 759500      74            mov LEDRB, #0
042C 759E00      75            mov LEDRC, #0
042F 75F800      76            mov LEDG, #0
0432 D2CA        77            setb TR2
0434 020437      78            ljmp Idle       
0437             79            
0437             80   ;awaiting process loop   
0437             81   Idle:
0437 754A00      82            mov Target_Temp, #0
043A C202        83            clr timing
043C D2A9        84            setb ET0
043E D2F9        85            setb LEDG.1
0440             86            ;Stop Timer
0440             87            ;set things while switch is up, return by flicking down
0440 20E935      88            jb SWA.1, Set_Reflow_Time
0443 20EA27      89            jb SWA.2, Set_Reflow_Temp
0446 20EB19      90            jb SWA.3, Set_Soak_Time
0449 20EC0B      91            jb SWA.4, Set_Soak_Temp
044C 20F9E8      92            jb Key.1, Idle
044F             93            ;ready to start process
044F 120258      94            lcall beep
0452 C200        95            clr Ready
0454 020483      96            ljmp Preheat_Soak
0457             97            
0457             98   ;------------------------------------------------------------------      
0457             99   ;Setting Times and Temperatures (Not Done)
0457            100   ;   -had thought maybe macro for time and temp, that takes bounds 
0457            101   ;   so the time or temp is within reason
0457            102   ;------------------------------------------------------------------
0457            103   Set_Soak_Temp:
0457 120572     104            lcall Set_Soak_Temp_Relay
045A 20ECFA     105            jb SWA.4, Set_Soak_Temp
045D 1201F8     106            lcall clear_hex
0460 80D5       107            sjmp Idle
0462            108   Set_Soak_Time:
0462 1205B7     109            lcall Set_Soak_Time_Relay
0465 20EBFA     110            jb SWA.3, Set_Soak_Time
0468 1201F8     111            lcall clear_hex
046B 80CA       112            Sjmp Idle
046D            113   Set_Reflow_Temp:
046D 12052D     114            lcall Set_Reflow_Temp_Relay
0470 20EAFA     115            jb SWA.2, Set_Reflow_Temp
0473 1201F8     116            lcall clear_hex
0476 80BF       117            Sjmp Idle
0478            118   Set_Reflow_Time:
0478 1204E8     119            lcall Set_Reflow_Time_Relay     
047B 20E9FA     120            jb SWA.1, Set_Reflow_Time
047E 1201F8     121            lcall clear_hex
0481 80B4       122            Sjmp Idle
0483            123   
0483            124   ;------------------------------------------------------------------      
0483            125   ;Actual Progression Through Phases
0483            126   ;PRE-HEAT
0483            127   ;SOAK
0483            128   ;PRE-HEAT
0483            129   ;REFLOW
0483            130   ;COOLING
0483            131   ;DONE
0483            132   ;------------------------------------------------------------------
0483            133   
0483            134   ;Waits for temperature to get above soak temp
0483            135   Preheat_Soak:
0483 D2FA       136            setb LEDG.2
0485 85484A     137            mov Target_Temp, Soak_Temp
0488 3000F8     138            jnb Ready, PreHeat_Soak
048B 120258     139            lcall beep
048E            140   ;Initialize for holding constant
048E D2FB       141            setb LEDG.3
0490 854937     142            mov seconds, Soak_Time+0
0493 C201       143            clr finished     
0495            144   WaitSoak:
0495 120205     145            lcall display_time      
0498 3001FA     146            jnb finished, WaitSoak
049B            147   ;Initilize for ramp to Reflow
049B 1201F8     148            lcall clear_hex
049E D2FC       149            setb LEDG.4
04A0 120258     150            lcall beep
04A3 85464A     151            mov Target_Temp, Reflow_Temp
04A6 C200       152            clr ready
04A8            153   Preheat_Reflow:
04A8 3000FD     154            jnb Ready, PreHeat_Reflow
04AB 120258     155            lcall beep
04AE            156   ;Pass Reflow Time, wait for time to expire       
04AE D2FD       157            setb LEDG.5
04B0 854737     158            mov seconds, Reflow_Time+0
04B3 C201       159            clr finished
04B5            160   WaitReflow:
04B5 120205     161            lcall display_time      
04B8 3001FA     162            jnb finished, WaitReflow
04BB 1201F8     163            lcall clear_hex
04BE 120258     164            lcall beep
04C1            165   ;Process Finished, Wait for it to cool
04C1            166   Cooling:
04C1 754A3C     167            mov Target_Temp, #CoolConst
04C4 D200       168            setb ready      
04C6            169   WaitCool:        
04C6 D2FE       170            setb LEDG.6
04C8            171            ;wait for temp to dip below 60 Celcius (Cool Constant)
04C8 2000FB     172            jb Ready, WaitCool
04CB            173            ;set temp to zero
04CB 754A00     174            mov Target_Temp, #0
04CE            175            ;triple beep
04CE 120258     176            lcall beep
04D1 12024B     177            lcall wait
04D4 120258     178            lcall beep
04D7 12024B     179            lcall wait
04DA 120258     180            lcall beep
04DD            181   ;Cool Enough (just waits PB)     
04DD            182   Done:
04DD D2FF       183            setb LEDG.7
04DF 20F9FB     184            jb Key.1, Done
04E2 75F800     185            mov LEDG, #0
04E5 020437     186            ljmp Idle
04E8            187                    
04E8            188   Set_Reflow_Time_Relay:
04E8            189            Inc_Reflow_Time:
04E8 E547       189                    mov A, Reflow_Time
04EA            189            
04EA 20FA08     189                    jb KEY.2, Dec_Reflow_Time
04ED 30FAFD     189            jnb KEY.2, $
04F0 04         189                    inc A
04F1 B42E0C     189                    cjne A, #46, Done_Reflow_Time
04F4 14         189                    dec A
04F5            189            Dec_Reflow_Time:        
04F5 20FB08     189                jb KEY.3, Done_Reflow_Time
04F8 30FBFD     189                jnb KEY.3, $
04FB 14         189                    dec A
04FC B41D01     189                cjne A, #29, Done_Reflow_Time
04FF 04         189           inc A
0500            189            Done_Reflow_Time:
0500 F547       189                    mov Reflow_Time, A
0502 85473A     190            mov x, Reflow_Time
0505 753B00     190            mov x+1, #0
0508 12001E     190            lcall hex2bcd
050B 900301     190            mov dptr, #myLUT
050E            190            ; Display Digit 0
050E E542       190       mov A, bcd+0
0510 540F       190       anl a, #0fh
0512 93         190       movc A, @A+dptr
0513 F58E       190       mov HEX4, A
0515            190            ; Display Digit 1
0515 E542       190       mov A, bcd+0
0517 C4         190       swap a
0518 540F       190       anl a, #0fh
051A 93         190       movc A, @A+dptr
051B F58F       190       mov HEX5, A    
051D            190       ; Display Digit 2
051D E543       190       mov A, bcd+1
051F 540F       190       anl a, #0fh
0521 6006       190       jz Ender_Reflow_Time
0523 93         190       movc A, @A+dptr
0524 F596       190       mov HEX6, A
0526 02052C     190       jmp Exit_Reflow_Time
0529            190       Ender_Reflow_Time:
0529 7596FF     190       mov HEX6, #0FFH
052C            190       Exit_Reflow_Time:
052C 22         191            ret     
052D            192   Set_Reflow_Temp_Relay:
052D            193            Inc_Reflow_Temp:
052D E546       193                    mov A, Reflow_Temp
052F            193            
052F 20FA08     193                    jb KEY.2, Dec_Reflow_Temp
0532 30FAFD     193            jnb KEY.2, $
0535 04         193                    inc A
0536 B4E70C     193                    cjne A, #231, Done_Reflow_Temp
0539 14         193                    dec A
053A            193            Dec_Reflow_Temp:        
053A 20FB08     193                jb KEY.3, Done_Reflow_Temp
053D 30FBFD     193                jnb KEY.3, $
0540 14         193                    dec A
0541 B4C701     193                cjne A, #199, Done_Reflow_Temp
0544 04         193           inc A
0545            193            Done_Reflow_Temp:
0545 F546       193                    mov Reflow_Temp, A
0547 85463A     194            mov x, Reflow_Temp
054A 753B00     194            mov x+1, #0
054D 12001E     194            lcall hex2bcd
0550 900301     194            mov dptr, #myLUT
0553            194            ; Display Digit 0
0553 E542       194       mov A, bcd+0
0555 540F       194       anl a, #0fh
0557 93         194       movc A, @A+dptr
0558 F58E       194       mov HEX4, A
055A            194            ; Display Digit 1
055A E542       194       mov A, bcd+0
055C C4         194       swap a
055D 540F       194       anl a, #0fh
055F 93         194       movc A, @A+dptr
0560 F58F       194       mov HEX5, A    
0562            194       ; Display Digit 2
0562 E543       194       mov A, bcd+1
0564 540F       194       anl a, #0fh
0566 6006       194       jz Ender_Reflow_Temp
0568 93         194       movc A, @A+dptr
0569 F596       194       mov HEX6, A
056B 020571     194       jmp Exit_Reflow_Temp
056E            194       Ender_Reflow_Temp:
056E 7596FF     194       mov HEX6, #0FFH
0571            194       Exit_Reflow_Temp:
0571 22         195            ret     
0572            196   Set_Soak_Temp_Relay:     
0572            197            Inc_Soak_Temp:
0572 E548       197                    mov A, Soak_Temp
0574            197            
0574 20FA08     197                    jb KEY.2, Dec_Soak_Temp
0577 30FAFD     197            jnb KEY.2, $
057A 04         197                    inc A
057B B4A50C     197                    cjne A, #165, Done_Soak_Temp
057E 14         197                    dec A
057F            197            Dec_Soak_Temp:  
057F 20FB08     197                jb KEY.3, Done_Soak_Temp
0582 30FBFD     197                jnb KEY.3, $
0585 14         197                    dec A
0586 B48601     197                cjne A, #134, Done_Soak_Temp
0589 04         197           inc A
058A            197            Done_Soak_Temp:
058A F548       197                    mov Soak_Temp, A
058C 85483A     198            mov x, Soak_Temp
058F 753B00     198            mov x+1, #0
0592 12001E     198            lcall hex2bcd
0595 900301     198            mov dptr, #myLUT
0598            198            ; Display Digit 0
0598 E542       198       mov A, bcd+0
059A 540F       198       anl a, #0fh
059C 93         198       movc A, @A+dptr
059D F58E       198       mov HEX4, A
059F            198            ; Display Digit 1
059F E542       198       mov A, bcd+0
05A1 C4         198       swap a
05A2 540F       198       anl a, #0fh
05A4 93         198       movc A, @A+dptr
05A5 F58F       198       mov HEX5, A    
05A7            198       ; Display Digit 2
05A7 E543       198       mov A, bcd+1
05A9 540F       198       anl a, #0fh
05AB 6006       198       jz Ender_Soak_Temp
05AD 93         198       movc A, @A+dptr
05AE F596       198       mov HEX6, A
05B0 0205B6     198       jmp Exit_Soak_Temp
05B3            198       Ender_Soak_Temp:
05B3 7596FF     198       mov HEX6, #0FFH
05B6            198       Exit_Soak_Temp:
05B6 22         199            ret     
05B7            200   Set_Soak_Time_Relay:
05B7            201            Inc_Soak_Time:
05B7 E549       201                    mov A, Soak_Time
05B9            201            
05B9 20FA08     201                    jb KEY.2, Dec_Soak_Time
05BC 30FAFD     201            jnb KEY.2, $
05BF 04         201                    inc A
05C0 B45B0C     201                    cjne A, #91, Done_Soak_Time
05C3 14         201                    dec A
05C4            201            Dec_Soak_Time:  
05C4 20FB08     201                jb KEY.3, Done_Soak_Time
05C7 30FBFD     201                jnb KEY.3, $
05CA 14         201                    dec A
05CB B43B01     201                cjne A, #59, Done_Soak_Time
05CE 04         201           inc A
05CF            201            Done_Soak_Time:
05CF F549       201                    mov Soak_Time, A
05D1 85493A     202            mov x, Soak_Time
05D4 753B00     202            mov x+1, #0
05D7 12001E     202            lcall hex2bcd
05DA 900301     202            mov dptr, #myLUT
05DD            202            ; Display Digit 0
05DD E542       202       mov A, bcd+0
05DF 540F       202       anl a, #0fh
05E1 93         202       movc A, @A+dptr
05E2 F58E       202       mov HEX4, A
05E4            202            ; Display Digit 1
05E4 E542       202       mov A, bcd+0
05E6 C4         202       swap a
05E7 540F       202       anl a, #0fh
05E9 93         202       movc A, @A+dptr
05EA F58F       202       mov HEX5, A    
05EC            202       ; Display Digit 2
05EC E543       202       mov A, bcd+1
05EE 540F       202       anl a, #0fh
05F0 6006       202       jz Ender_Soak_Time
05F2 93         202       movc A, @A+dptr
05F3 F596       202       mov HEX6, A
05F5 0205FB     202       jmp Exit_Soak_Time
05F8            202       Ender_Soak_Time:
05F8 7596FF     202       mov HEX6, #0FFH
05FB            202       Exit_Soak_Time:
05FB 22         203            ret
05FC            204                    
05FC            205   END
